# Entitlement Creation Guide

Learn how to create and manage entitlements in Stratium to grant users access to resources based on their attributes.

## Table of Contents
- [Overview](#overview)
- [Entitlements vs Policies](#entitlements-vs-policies)
- [Entitlement Structure](#entitlement-structure)
- [Creating Entitlements](#creating-entitlements)
- [Examples](#examples)
- [Best Practices](#best-practices)
- [Testing](#testing)
- [Troubleshooting](#troubleshooting)

## Overview

Entitlements in Stratium define **who** can perform **what actions** on **which resources**. They work alongside policies to provide fine-grained access control.

**Key Concepts:**
- **Subject Attributes**: Characteristics of the user/entity requesting access (e.g., department, role, clearance)
- **Resource Attributes**: Characteristics of the resource being accessed (e.g., classification, owner, project)
- **Actions**: Operations that can be performed (e.g., read, write, delete, approve)
- **Conditions**: Optional additional constraints (e.g., time-based, location-based)

## Entitlements vs Policies

Understanding the difference between entitlements and policies is crucial:

| Aspect | Entitlements | Policies |
|--------|--------------|----------|
| **Purpose** | Define access grants | Define access rules |
| **Granularity** | Coarse-grained | Fine-grained |
| **Flexibility** | Fixed attribute matching | Complex logic, conditions |
| **Use Case** | "Engineering can read engineering docs" | "Users with SECRET clearance can read CONFIDENTIAL docs during business hours" |
| **Evaluation** | Attribute matching | Rule evaluation (JSON/OPA/XACML) |

**Typical Flow:**
1. Request arrives with subject and resource attributes
2. **Entitlements** check: Does this subject have any entitlement for this resource type?
3. **Policy** evaluation: Do the policies allow this specific action?
4. Both must pass for access to be granted

**When to use:**
- **Entitlements**: Grant broad access based on department, role, or group membership
- **Policies**: Enforce specific rules like security clearance checks, time restrictions, or complex business logic

## Entitlement Structure

### Basic Entitlement

```json
{
  "id": "unique-entitlement-id",
  "name": "Human Readable Name",
  "description": "What this entitlement grants",
  "enabled": true,
  "subject_attributes": {
    "attribute_name": "value"
  },
  "resource_attributes": {
    "attribute_name": "value"
  },
  "actions": ["read", "write"],
  "conditions": {
    "time_based": {},
    "location_based": {}
  }
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | No* | Unique identifier (auto-generated if not provided) |
| `name` | string | Yes | Human-readable entitlement name |
| `description` | string | No | Detailed description |
| `enabled` | boolean | No | Whether entitlement is active (default: true) |
| `subject_attributes` | object | Yes | Attributes the subject must have |
| `resource_attributes` | object | Yes | Attributes the resource must have |
| `actions` | array | Yes | List of allowed actions |
| `conditions` | object | No | Additional constraints |

\* Auto-generated by the system if not provided

### Subject Attributes

Define characteristics the requesting user must have:

```json
{
  "subject_attributes": {
    "department": "engineering",
    "role": "engineer",
    "clearance": "SECRET",
    "groups": ["developers", "security-team"],
    "employee_type": "full-time"
  }
}
```

**Common subject attributes:**
- `department`: User's department
- `role`: User's role or job function
- `clearance`: Security clearance level
- `groups`: Group memberships
- `employee_type`: Type of employee (full-time, contractor, etc.)
- `location`: User's geographic location
- `division`: Business division

### Resource Attributes

Define characteristics the resource must have:

```json
{
  "resource_attributes": {
    "resource_type": "database",
    "classification": "CONFIDENTIAL",
    "project": "project-alpha",
    "owner": "engineering",
    "data_category": "financial"
  }
}
```

**Common resource attributes:**
- `resource_type`: Type of resource (database, file, API, etc.)
- `classification`: Security classification
- `project`: Project or initiative
- `owner`: Owning department or user
- `data_category`: Category of data
- `sensitivity`: Sensitivity level

### Actions

Specify what operations are allowed:

```json
{
  "actions": ["read", "write", "delete", "approve", "export"]
}
```

**Standard actions:**
- `read`: View or retrieve resource
- `write`: Modify or update resource
- `delete`: Remove resource
- `create`: Create new resources
- `approve`: Approve changes or requests
- `export`: Export data outside system
- `share`: Share with others
- `admin`: Administrative operations

### Conditions

Optional constraints for time-based or location-based access:

```json
{
  "conditions": {
    "time_based": {
      "start_time": "2025-01-01T00:00:00Z",
      "end_time": "2025-12-31T23:59:59Z",
      "days_of_week": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      "hours": {
        "start": 9,
        "end": 17
      }
    },
    "location_based": {
      "allowed_countries": ["US", "UK", "CA"],
      "allowed_regions": ["us-east", "eu-west"]
    }
  }
}
```

## Creating Entitlements

### Via REST API

Create an entitlement using the Stratium API:

```bash
POST /api/v1/entitlements
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Engineering Database Access",
  "description": "Allow engineering staff to read and write engineering databases",
  "subject_attributes": {
    "department": "engineering"
  },
  "resource_attributes": {
    "resource_type": "database",
    "owner": "engineering"
  },
  "actions": ["read", "write"]
}
```

**Response:**

```json
{
  "id": "ent-12345",
  "name": "Engineering Database Access",
  "description": "Allow engineering staff to read and write engineering databases",
  "enabled": true,
  "subject_attributes": {
    "department": "engineering"
  },
  "resource_attributes": {
    "resource_type": "database",
    "owner": "engineering"
  },
  "actions": ["read", "write"],
  "created_at": "2025-01-15T10:00:00Z",
  "updated_at": "2025-01-15T10:00:00Z"
}
```

### Via Admin UI

If using the Stratium Admin UI:

1. Navigate to **Entitlements** > **Create New**
2. Fill in entitlement details:
   - Name and description
   - Subject attributes
   - Resource attributes
   - Allowed actions
3. (Optional) Add time-based or location-based conditions
4. Click **Create Entitlement**
5. Test with sample access request

## Examples

### Example 1: Department-Based Access

Grant department members access to department resources:

```json
{
  "name": "Finance Department Data Access",
  "description": "Finance team can read and update financial data",
  "subject_attributes": {
    "department": "finance"
  },
  "resource_attributes": {
    "data_category": "financial",
    "resource_type": "database"
  },
  "actions": ["read", "write", "export"]
}
```

**Use case**: Finance team members can access financial databases and export reports.

### Example 2: Role-Based Access

Grant specific roles access to resources:

```json
{
  "name": "Manager Approval Access",
  "description": "Managers can approve requests",
  "subject_attributes": {
    "role": "manager"
  },
  "resource_attributes": {
    "resource_type": "approval_request"
  },
  "actions": ["read", "approve", "reject"]
}
```

**Use case**: Any user with the "manager" role can approve or reject requests.

### Example 3: Project-Based Access

Grant project team members access to project resources:

```json
{
  "name": "Project Alpha Team Access",
  "description": "Project Alpha team members can access project resources",
  "subject_attributes": {
    "project": "alpha",
    "employee_type": "full-time"
  },
  "resource_attributes": {
    "project": "alpha",
    "resource_type": "document"
  },
  "actions": ["read", "write", "comment"]
}
```

**Use case**: Full-time employees assigned to Project Alpha can collaborate on project documents.

### Example 4: Clearance-Based Access

Grant access based on security clearance:

```json
{
  "name": "Classified Document Access",
  "description": "Users with SECRET clearance can access SECRET and below documents",
  "subject_attributes": {
    "clearance": "SECRET"
  },
  "resource_attributes": {
    "resource_type": "document",
    "classification": "SECRET"
  },
  "actions": ["read"]
}
```

**Use case**: Users with SECRET clearance can read SECRET classified documents.

**Note**: For hierarchical clearance checks (SECRET can access CONFIDENTIAL), use policies in combination with entitlements.

### Example 5: Time-Limited Access

Grant temporary access to contractors:

```json
{
  "name": "Contractor Temporary Access",
  "description": "Contractors have limited access during contract period",
  "subject_attributes": {
    "employee_type": "contractor",
    "project": "beta"
  },
  "resource_attributes": {
    "project": "beta",
    "resource_type": "code_repository"
  },
  "actions": ["read", "write"],
  "conditions": {
    "time_based": {
      "start_time": "2025-01-01T00:00:00Z",
      "end_time": "2025-06-30T23:59:59Z",
      "days_of_week": ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
      "hours": {
        "start": 9,
        "end": 17
      }
    }
  }
}
```

**Use case**: Contractors on Project Beta can access code repositories only during business hours and only until their contract ends.

### Example 6: Group-Based Access

Grant access based on group membership:

```json
{
  "name": "Security Team Admin Access",
  "description": "Security team members have admin access to security tools",
  "subject_attributes": {
    "groups": ["security-team", "incident-response"]
  },
  "resource_attributes": {
    "resource_type": "security_tool",
    "category": "monitoring"
  },
  "actions": ["read", "write", "admin", "configure"]
}
```

**Use case**: Members of security or incident response groups can fully manage security monitoring tools.

### Example 7: Multi-Attribute Matching

Grant access based on multiple subject attributes:

```json
{
  "name": "Senior Engineer Data Science Access",
  "description": "Senior engineers in data science can access ML datasets",
  "subject_attributes": {
    "role": "senior_engineer",
    "department": "data-science",
    "clearance": "CONFIDENTIAL"
  },
  "resource_attributes": {
    "resource_type": "dataset",
    "category": "machine_learning",
    "classification": "CONFIDENTIAL"
  },
  "actions": ["read", "write", "train_model"]
}
```

**Use case**: Only senior engineers in data science with appropriate clearance can work with ML datasets.

### Example 8: Location-Based Access

Restrict access based on geographic location:

```json
{
  "name": "EU Data Access - EU Employees Only",
  "description": "Only EU-based employees can access EU customer data",
  "subject_attributes": {
    "location": "EU",
    "employee_type": "full-time"
  },
  "resource_attributes": {
    "data_category": "customer_data",
    "region": "EU"
  },
  "actions": ["read", "write"],
  "conditions": {
    "location_based": {
      "allowed_countries": ["DE", "FR", "IT", "ES", "NL", "BE"],
      "allowed_regions": ["eu-west", "eu-central"]
    }
  }
}
```

**Use case**: GDPR compliance - only EU employees can access EU customer data.

## Best Practices

### 1. Use Descriptive Names

✅ Good:
```json
{
  "name": "Engineering Team - Production Database Read Access",
  "description": "Engineering team members can read production databases for monitoring and debugging"
}
```

❌ Bad:
```json
{
  "name": "Entitlement 1",
  "description": "Access"
}
```

### 2. Keep Entitlements Focused

Each entitlement should grant access for a single, clear purpose.

✅ Good - Separate entitlements:
```json
// Entitlement 1: Read access
{
  "name": "Engineering - Database Read",
  "subject_attributes": {"department": "engineering"},
  "resource_attributes": {"resource_type": "database"},
  "actions": ["read"]
}

// Entitlement 2: Write access (fewer users)
{
  "name": "Senior Engineering - Database Write",
  "subject_attributes": {"department": "engineering", "role": "senior_engineer"},
  "resource_attributes": {"resource_type": "database"},
  "actions": ["write"]
}
```

❌ Bad - Too broad:
```json
{
  "name": "Engineering All Access",
  "subject_attributes": {"department": "engineering"},
  "resource_attributes": {},
  "actions": ["read", "write", "delete", "admin"]
}
```

### 3. Combine with Policies

Use entitlements for broad access grants, policies for fine-grained control:

**Entitlement** (who can access):
```json
{
  "name": "Security Team Document Access",
  "subject_attributes": {"department": "security"},
  "resource_attributes": {"resource_type": "document"},
  "actions": ["read"]
}
```

**Policy** (specific constraints):
```json
{
  "name": "Clearance Check for Classified Documents",
  "effect": "allow",
  "language": "json",
  "policy_content": {
    "conditions": {
      "subject": {
        "clearance": {"$gte": "$resource.classification"}
      }
    }
  }
}
```

Combined: Security team members can access documents, but only if their clearance meets the document classification.

### 4. Use Time-Based Conditions for Temporary Access

Always set end dates for contractor or temporary access:

```json
{
  "name": "Q1 Contractor Access",
  "subject_attributes": {"employee_type": "contractor"},
  "conditions": {
    "time_based": {
      "start_time": "2025-01-01T00:00:00Z",
      "end_time": "2025-03-31T23:59:59Z"
    }
  }
}
```

### 5. Document Purpose and Ownership

Always include clear descriptions:

```json
{
  "name": "Finance Q4 Audit Access",
  "description": "Temporary access for external auditors to financial records during Q4 audit. Owner: Jane Doe (Finance VP). Expires: 2025-12-31.",
  "subject_attributes": {"role": "auditor", "project": "q4-audit"},
  "actions": ["read", "export"]
}
```

### 6. Principle of Least Privilege

Grant only the minimum necessary actions:

✅ Good:
```json
{
  "name": "Support Team - Read Only Access",
  "actions": ["read"]  // Only what's needed for support
}
```

❌ Bad:
```json
{
  "name": "Support Team Access",
  "actions": ["read", "write", "delete", "admin"]  // Too much!
}
```

### 7. Regular Audits

Implement periodic entitlement reviews:

- **Monthly**: Review temporary/contractor entitlements
- **Quarterly**: Review department-based entitlements
- **Annually**: Review all entitlements for accuracy
- **On employee change**: Immediately update when roles change

### 8. Naming Conventions

Adopt a consistent naming pattern:

```
[Subject Group] - [Resource Type] - [Action Level]

Examples:
- "Engineering - Database - Read"
- "Finance - Reports - Write"
- "Admins - All Resources - Full Access"
- "Contractors - Project Alpha - Limited"
```

## Testing

### Test Entitlement via API

Test if an entitlement grants access for a specific request:

```bash
POST /api/v1/entitlements/test
Content-Type: application/json

{
  "subject_attributes": {
    "department": "engineering",
    "role": "engineer"
  },
  "resource_attributes": {
    "resource_type": "database",
    "owner": "engineering"
  },
  "action": "read"
}
```

**Response:**

```json
{
  "granted": true,
  "matching_entitlements": [
    {
      "id": "ent-12345",
      "name": "Engineering Database Access",
      "matched_attributes": {
        "subject": ["department"],
        "resource": ["resource_type", "owner"]
      }
    }
  ],
  "reason": "Subject and resource attributes match entitlement 'Engineering Database Access'"
}
```

### Test with Sample Users

Create test users with various attributes:

```json
// Test User 1: Engineering
{
  "user_id": "test-eng-001",
  "attributes": {
    "department": "engineering",
    "role": "engineer",
    "clearance": "CONFIDENTIAL"
  }
}

// Test User 2: Finance
{
  "user_id": "test-fin-001",
  "attributes": {
    "department": "finance",
    "role": "analyst",
    "clearance": "RESTRICTED"
  }
}
```

Test access requests:

```bash
POST /api/v1/authorize
Content-Type: application/json

{
  "subject": {
    "user_id": "test-eng-001",
    "department": "engineering",
    "role": "engineer"
  },
  "resource": {
    "resource_type": "database",
    "owner": "engineering"
  },
  "action": "read"
}
```

### Common Test Cases

Always test these scenarios:

1. **Exact Match**: All attributes match exactly ✅
2. **Partial Match**: Some attributes match, some don't ❌
3. **No Match**: No attributes match ❌
4. **Extra Attributes**: Subject has extra attributes not in entitlement ✅ (should still match)
5. **Missing Attributes**: Subject missing required attributes ❌
6. **Wrong Action**: Attributes match but action not in list ❌
7. **Time Expired**: Conditions expired ❌
8. **Disabled Entitlement**: Entitlement exists but disabled ❌

## Troubleshooting

### Entitlement Not Matching

**Problem**: Expected entitlement isn't granting access

**Debug steps:**

1. **Check if enabled**:
   ```bash
   GET /api/v1/entitlements/{id}
   ```
   Verify `"enabled": true`

2. **Check attribute names** (case-sensitive):
   ```json
   // ❌ Won't match
   {"Department": "engineering"}  // Capital D

   // ✅ Matches
   {"department": "engineering"}  // Lowercase d
   ```

3. **Check attribute values** (exact match required):
   ```json
   // ❌ Won't match
   {"department": "Engineering"}  // Capital E

   // ✅ Matches
   {"department": "engineering"}  // Lowercase e
   ```

4. **Verify all required attributes are present**:
   ```json
   // Entitlement requires both:
   {
     "subject_attributes": {
       "department": "engineering",
       "role": "engineer"
     }
   }

   // ❌ Subject only has department
   {
     "department": "engineering"
   }

   // ✅ Subject has both
   {
     "department": "engineering",
     "role": "engineer"
   }
   ```

5. **Check audit logs**:
   ```bash
   GET /api/v1/audit-logs?user_id=<user>&action=access_denied
   ```

### Access Denied Despite Entitlement

**Problem**: Entitlement matches but access still denied

**Possible causes:**

1. **Policy evaluation failed**: Entitlement grants access, but policy denies it
   - Check policy evaluation logs
   - Verify policies aren't overriding entitlement

2. **Time conditions expired**:
   ```json
   {
     "conditions": {
       "time_based": {
         "end_time": "2025-01-14T23:59:59Z"  // Already passed!
       }
     }
   }
   ```

3. **Location mismatch**:
   ```json
   {
     "conditions": {
       "location_based": {
         "allowed_countries": ["US"]  // User in UK
       }
     }
   }
   ```

4. **Action not in allowed list**:
   ```json
   {
     "actions": ["read"]  // User trying to "write"
   }
   ```

### Multiple Entitlements Conflicting

**Problem**: Unclear which entitlement is being used

**Solution**: Check entitlement priority and evaluation order

```bash
GET /api/v1/entitlements/evaluate-all
Content-Type: application/json

{
  "subject_attributes": {"department": "engineering"},
  "resource_attributes": {"resource_type": "database"},
  "action": "read"
}
```

**Response shows all matching entitlements:**

```json
{
  "matching_entitlements": [
    {"id": "ent-1", "name": "Engineering Read Access", "priority": 100},
    {"id": "ent-2", "name": "All Employees Read Access", "priority": 50}
  ],
  "applied_entitlement": "ent-1",
  "reason": "Higher priority"
}
```

### Entitlement Too Broad

**Problem**: Entitlement grants too much access

**Solution**: Split into multiple narrower entitlements

❌ Too broad:
```json
{
  "name": "Engineering Access",
  "subject_attributes": {"department": "engineering"},
  "resource_attributes": {},  // Matches everything!
  "actions": ["read", "write", "delete"]
}
```

✅ Split into focused entitlements:
```json
// Read access - broad
{
  "name": "Engineering - Read Access",
  "subject_attributes": {"department": "engineering"},
  "resource_attributes": {"owner": "engineering"},
  "actions": ["read"]
}

// Write access - restricted
{
  "name": "Senior Engineering - Write Access",
  "subject_attributes": {"department": "engineering", "role": "senior_engineer"},
  "resource_attributes": {"owner": "engineering"},
  "actions": ["write"]
}

// Delete access - very restricted
{
  "name": "Engineering Leads - Delete Access",
  "subject_attributes": {"department": "engineering", "role": "lead"},
  "resource_attributes": {"owner": "engineering"},
  "actions": ["delete"]
}
```

## API Reference

### Create Entitlement

```bash
POST /api/v1/entitlements
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Entitlement Name",
  "subject_attributes": {},
  "resource_attributes": {},
  "actions": []
}
```

### Get Entitlement

```bash
GET /api/v1/entitlements/{id}
Authorization: Bearer <token>
```

### Update Entitlement

```bash
PUT /api/v1/entitlements/{id}
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "Updated Name",
  "enabled": false
}
```

### Delete Entitlement

```bash
DELETE /api/v1/entitlements/{id}
Authorization: Bearer <token>
```

### List Entitlements

```bash
GET /api/v1/entitlements?enabled=true&department=engineering
Authorization: Bearer <token>
```

### Test Entitlement

```bash
POST /api/v1/entitlements/test
Content-Type: application/json

{
  "subject_attributes": {},
  "resource_attributes": {},
  "action": "read"
}
```

## Next Steps

- [Learn about JSON Policies](../policies/JSON_POLICIES.md)
- [Learn about OPA Policies](../policies/OPA_POLICIES.md)
- [Learn about XACML Policies](../policies/XACML_POLICIES.md)
- [Entitlement Examples](./EXAMPLES.md)
- [Integration Guide](../integration/OIDC_INTEGRATION.md)

## Support

Need help with entitlements?
- Technical Support: support@stratium.example
- Documentation Issues: Create an issue in the repository
- Security Issues: security@stratium.example

## License

Copyright © 2025 Stratium Data

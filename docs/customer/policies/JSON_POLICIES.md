# JSON Policy Creation Guide

JSON policies provide a simple, declarative way to define authorization rules using standard JSON syntax with powerful operators.

## Table of Contents
- [Overview](#overview)
- [Policy Structure](#policy-structure)
- [Operators](#operators)
- [Examples](#examples)
- [Best Practices](#best-practices)
- [Testing](#testing)

## Overview

JSON policies are the simplest and most commonly used policy format in Stratium. They allow you to define authorization rules using familiar JSON syntax with support for:

- Attribute-based access control (ABAC)
- Role-based access control (RBAC)
- Hierarchical attribute matching (e.g., security clearances)
- Complex boolean logic (AND, OR, NOT)
- Rich comparison operators

**When to use JSON policies:**
- Simple to moderate complexity rules
- Attribute-based decisions
- Quick prototyping and testing
- Teams familiar with JSON

## Policy Structure

###

 Basic Structure

```json
{
  "id": "unique-policy-id",
  "name": "Human Readable Policy Name",
  "description": "What this policy does",
  "effect": "allow",
  "language": "json",
  "priority": 100,
  "enabled": true,
  "policy_content": {
    "conditions": {
      "subject": { /* subject conditions */ },
      "resource": { /* resource conditions */ },
      "action": { /* action conditions */ }
    }
  }
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | No* | Unique identifier (auto-generated if not provided) |
| `name` | string | Yes | Human-readable policy name |
| `description` | string | No | Detailed description of the policy |
| `effect` | string | Yes | Either `"allow"` or `"deny"` |
| `language` | string | Yes | Must be `"json"` |
| `priority` | number | No | Higher numbers = higher priority (default: 0) |
| `enabled` | boolean | No | Whether policy is active (default: true) |
| `policy_content` | object | Yes | The policy rules |

\* Auto-generated by the system if not provided

### Policy Content Structure

The `policy_content` object contains the actual policy logic:

```json
{
  "policy_content": {
    "conditions": {
      "subject": {
        // Conditions about the user/subject
        "attribute_name": { "operator": "value" }
      },
      "resource": {
        // Conditions about the resource being accessed
        "attribute_name": { "operator": "value" }
      },
      "action": {
        // Conditions about the action being performed
        "action_name": { "operator": "value" }
      },
      "environment": {
        // Optional: Conditions about the environment
        "attribute_name": { "operator": "value" }
      }
    }
  }
}
```

## Operators

JSON policies support a rich set of operators for flexible rule definition.

### Comparison Operators

#### `$eq` - Equals

Exact match comparison.

```json
{
  "subject": {
    "department": { "$eq": "engineering" }
  }
}
```

#### `$ne` - Not Equals

Inverse of equals.

```json
{
  "subject": {
    "status": { "$ne": "suspended" }
  }
}
```

#### `$in` - In Array

Check if value is in a list.

```json
{
  "subject": {
    "role": { "$in": ["admin", "manager", "supervisor"] }
  }
}
```

#### `$nin` - Not In Array

Check if value is NOT in a list.

```json
{
  "subject": {
    "department": { "$nin": ["sales", "marketing"] }
  }
}
```

### Numeric Operators

#### `$gt` / `$gte` - Greater Than / Greater Than or Equal

```json
{
  "subject": {
    "age": { "$gte": 18 },
    "experience_years": { "$gt": 5 }
  }
}
```

#### `$lt` / `$lte` - Less Than / Less Than or Equal

```json
{
  "resource": {
    "sensitivity_level": { "$lte": 3 },
    "size_mb": { "$lt": 100 }
  }
}
```

### Hierarchical Operators

For attributes with hierarchical values (like security clearances):

```json
{
  "subject": {
    "clearance": { "$gte": "$resource.classification" }
  }
}
```

**Supported hierarchies:**
- `classification` / `clearance`: UNCLASSIFIED < RESTRICTED < CONFIDENTIAL < SECRET < TOP-SECRET
- `sensitivity`: PUBLIC < INTERNAL < CONFIDENTIAL < RESTRICTED < HIGHLY-CONFIDENTIAL

### Pattern Operators

#### `$contains` - Array Contains

Check if an array contains a specific value.

```json
{
  "subject": {
    "groups": { "$contains": "developers" }
  }
}
```

#### `$regex` - Regular Expression Match

```json
{
  "subject": {
    "email": { "$regex": ".*@company\\.com$" }
  }
}
```

### Reference Operators

Reference other attributes in the evaluation context using `$resource`, `$subject`, or `$environment` prefixes:

```json
{
  "subject": {
    "department": { "$eq": "$resource.owning_department" }
  }
}
```

## Examples

### Example 1: Simple Department Access

Allow engineering department to access engineering resources:

```json
{
  "name": "Engineering Department Access",
  "description": "Allow engineering staff to access engineering resources",
  "effect": "allow",
  "language": "json",
  "priority": 100,
  "enabled": true,
  "policy_content": {
    "conditions": {
      "subject": {
        "department": { "$eq": "engineering" }
      },
      "resource": {
        "resource_type": { "$eq": "engineering_data" }
      }
    }
  }
}
```

### Example 2: Role-Based Access Control

Allow admins and managers to perform administrative actions:

```json
{
  "name": "Admin Actions Policy",
  "description": "Allow admins and managers to perform admin actions",
  "effect": "allow",
  "language": "json",
  "priority": 200,
  "policy_content": {
    "conditions": {
      "subject": {
        "role": { "$in": ["admin", "manager"] }
      },
      "action": {
        "action_name": { "$in": ["create", "update", "delete", "approve"] }
      }
    }
  }
}
```

### Example 3: Hierarchical Clearance Check

Allow access if user's clearance meets or exceeds document classification:

```json
{
  "name": "Classification Access Policy",
  "description": "Grant access based on security clearance hierarchy",
  "effect": "allow",
  "language": "json",
  "priority": 500,
  "policy_content": {
    "conditions": {
      "subject": {
        "clearance": { "$gte": "$resource.classification" }
      }
    }
  }
}
```

**Example evaluation:**
- User with `clearance: "SECRET"` can access `classification: "CONFIDENTIAL"` ✅
- User with `clearance: "CONFIDENTIAL"` cannot access `classification: "SECRET"` ❌

### Example 4: Resource Owner Access

Allow users to access resources they own:

```json
{
  "name": "Resource Owner Access",
  "description": "Users can access their own resources",
  "effect": "allow",
  "language": "json",
  "priority": 300,
  "policy_content": {
    "conditions": {
      "subject": {
        "user_id": { "$eq": "$resource.owner_id" }
      }
    }
  }
}
```

### Example 5: Time-Based Access

Limit access to business hours:

```json
{
  "name": "Business Hours Access",
  "description": "Allow access only during business hours",
  "effect": "allow",
  "language": "json",
  "priority": 150,
  "policy_content": {
    "conditions": {
      "environment": {
        "hour": { "$gte": 9, "$lte": 17 },
        "day_of_week": { "$in": ["Mon", "Tue", "Wed", "Thu", "Fri"] }
      }
    }
  }
}
```

### Example 6: Multi-Condition Policy

Complex policy with multiple conditions (all must be true):

```json
{
  "name": "Sensitive Data Access",
  "description": "Strict requirements for sensitive data",
  "effect": "allow",
  "language": "json",
  "priority": 1000,
  "policy_content": {
    "conditions": {
      "subject": {
        "clearance": { "$gte": "SECRET" },
        "training_completed": { "$eq": true },
        "department": { "$in": ["security", "legal", "compliance"] }
      },
      "resource": {
        "classification": { "$lte": "SECRET" },
        "data_retention_years": { "$lte": 5 }
      },
      "action": {
        "action_name": { "$eq": "read" }
      }
    }
  }
}
```

### Example 7: Deny Policy

Explicitly deny access to suspended users:

```json
{
  "name": "Deny Suspended Users",
  "description": "Block all access for suspended accounts",
  "effect": "deny",
  "language": "json",
  "priority": 9999,
  "policy_content": {
    "conditions": {
      "subject": {
        "account_status": { "$eq": "suspended" }
      }
    }
  }
}
```

Note: Deny policies typically have higher priority and override allow policies.

## Best Practices

### 1. Use Descriptive Names

✅ Good:
```json
{
  "name": "Engineering Department Database Read Access",
  "description": "Allow engineering staff to read from engineering databases"
}
```

❌ Bad:
```json
{
  "name": "Policy 1",
  "description": "Some policy"
}
```

### 2. Set Appropriate Priorities

- **9000-10000**: Critical deny policies (e.g., suspended accounts)
- **5000-8999**: Security policies (e.g., clearance checks)
- **1000-4999**: Department/role policies
- **0-999**: General access policies

### 3. Keep Conditions Simple

Break complex policies into multiple simpler policies:

✅ Good:
```json
// Policy 1: Check clearance
{
  "conditions": {
    "subject": {
      "clearance": { "$gte": "$resource.classification" }
    }
  }
}

// Policy 2: Check department
{
  "conditions": {
    "subject": {
      "department": { "$eq": "$resource.owning_department" }
    }
  }
}
```

❌ Bad:
```json
{
  "conditions": {
    "subject": {
      "clearance": { "$gte": "$resource.classification" },
      "department": { "$eq": "$resource.owning_department" },
      "role": { "$in": ["viewer", "editor", "admin"] },
      "training_completed": { "$eq": true },
      "account_status": { "$ne": "suspended" }
    }
  }
}
```

### 4. Use References for Dynamic Comparisons

When comparing subject and resource attributes:

✅ Good:
```json
{
  "subject": {
    "project": { "$eq": "$resource.project" }
  }
}
```

❌ Bad (hardcoded):
```json
{
  "subject": {
    "project": { "$eq": "project-alpha" }
  },
  "resource": {
    "project": { "$eq": "project-alpha" }
  }
}
```

### 5. Enable Policies Gradually

When deploying new policies:

1. Create policy with `"enabled": false`
2. Test in non-production environment
3. Enable policy with low priority
4. Monitor access logs
5. Adjust priority as needed

### 6. Document Complex Logic

Use the description field to explain complex conditions:

```json
{
  "name": "Multi-Region Data Access",
  "description": "Allows users to access data from their home region OR any region if they have the global_access role. Requires clearance >= CONFIDENTIAL for cross-region access.",
  "policy_content": {
    // complex conditions here
  }
}
```

## Testing

### Test with the Policy API

Test your policy before deploying:

```bash
POST /api/v1/policies/test
Content-Type: application/json

{
  "policy": {
    "effect": "allow",
    "language": "json",
    "policy_content": {
      "conditions": {
        "subject": {
          "clearance": { "$gte": "$resource.classification" }
        }
      }
    }
  },
  "evaluation_context": {
    "subject": {
      "clearance": "SECRET"
    },
    "resource": {
      "classification": "CONFIDENTIAL"
    }
  }
}
```

Response:
```json
{
  "result": true,
  "effect": "allow",
  "details": {
    "matched_conditions": ["subject.clearance"],
    "hierarchy_comparisons": {
      "clearance_vs_classification": {
        "subject_level": 3,
        "resource_level": 2,
        "result": "allow"
      }
    }
  }
}
```

### Common Test Cases

Always test these scenarios:

1. **Exact match**: Subject attribute exactly equals required value
2. **Hierarchy pass**: Subject level is higher than required
3. **Hierarchy fail**: Subject level is lower than required
4. **Missing attribute**: Required attribute is not present
5. **Array membership**: Value is/isn't in required array
6. **Multiple conditions**: All conditions must pass

### Validation Endpoint

Validate policy syntax before creating:

```bash
POST /api/v1/policies/validate
Content-Type: application/json

{
  "language": "json",
  "policy_content": { /* your policy */ }
}
```

## Troubleshooting

### Policy Not Matching

**Problem**: Policy exists but access is denied

**Checklist**:
1. Is policy enabled? (`"enabled": true`)
2. Does subject have all required attributes?
3. Are attribute names spelled correctly (case-sensitive)?
4. Is a higher-priority deny policy overriding?
5. Check audit logs for evaluation details

### Hierarchical Comparison Failing

**Problem**: `$gte` not working for clearance checks

**Solution**: Ensure both values are valid hierarchy levels:

```json
// Valid levels for classification:
["UNCLASSIFIED", "RESTRICTED", "CONFIDENTIAL", "SECRET", "TOP-SECRET"]

// Invalid (will fall back to string comparison):
["U", "R", "C", "S", "TS"]  // Use full names or configure aliases
```

### Multiple Policies Conflicting

**Problem**: Unexpected allow/deny results

**Solution**: Check priority ordering:

```bash
GET /api/v1/policies?sort=priority:desc
```

Remember: **Deny policies override allow policies** at the same priority level.

## Next Steps

- [Learn about OPA Policies](./OPA_POLICIES.md) for more complex logic
- [Learn about XACML Policies](./XACML_POLICIES.md) for enterprise compliance
- [Policy Best Practices](./BEST_PRACTICES.md)
- [Create Entitlements](../entitlements/CREATING_ENTITLEMENTS.md)

## API Reference

### Create Policy

```bash
POST /api/v1/policies
Content-Type: application/json

{
  "name": "My Policy",
  "effect": "allow",
  "language": "json",
  "policy_content": { /* ... */ }
}
```

### Update Policy

```bash
PUT /api/v1/policies/{id}
Content-Type: application/json

{
  "name": "Updated Policy Name",
  "enabled": false
}
```

### Delete Policy

```bash
DELETE /api/v1/policies/{id}
```

### List Policies

```bash
GET /api/v1/policies?language=json&enabled=true
```

## Support

Need help?
- Check the [FAQ](../FAQ.md)
- Review [Policy Examples](./EXAMPLES.md)
- Contact support: support@stratium.example
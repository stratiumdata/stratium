{{- if .Values.awsSecretsManager.enabled }}
{{- $storeName := .Values.awsSecretsManager.secretStoreRef.name | default "" }}
{{- $storeKind := .Values.awsSecretsManager.secretStoreRef.kind | default "SecretStore" }}
{{- $refresh := .Values.awsSecretsManager.refreshInterval | default "1h" }}
{{- if eq $storeName "" }}
{{- fail "awsSecretsManager.enabled=true requires awsSecretsManager.secretStoreRef.name" }}
{{- end }}

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "stratium.stratiumSecretName" . }}
  labels:
    {{- include "stratium.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ $refresh }}
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  target:
    name: {{ include "stratium.stratiumSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: database-password
      remoteRef:
        key: {{ .Values.awsSecretsManager.stratiumSecretId | quote }}
        property: database-password
    - secretKey: key-manager-oidc-secret
      remoteRef:
        key: {{ .Values.awsSecretsManager.stratiumSecretId | quote }}
        property: key-manager-oidc-secret
    - secretKey: key-access-oidc-secret
      remoteRef:
        key: {{ .Values.awsSecretsManager.stratiumSecretId | quote }}
        property: key-access-oidc-secret
    - secretKey: pap-oidc-secret
      remoteRef:
        key: {{ .Values.awsSecretsManager.stratiumSecretId | quote }}
        property: pap-oidc-secret

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "stratium.keycloakSecretName" . }}
  labels:
    {{- include "stratium.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ $refresh }}
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  target:
    name: {{ include "stratium.keycloakSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: admin-user
      remoteRef:
        key: {{ .Values.awsSecretsManager.keycloakSecretId | quote }}
        property: admin-user
    - secretKey: admin-password
      remoteRef:
        key: {{ .Values.awsSecretsManager.keycloakSecretId | quote }}
        property: admin-password

---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ include "stratium.postgresqlSecretName" . }}
  labels:
    {{- include "stratium.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ $refresh }}
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  target:
    name: {{ include "stratium.postgresqlSecretName" . }}
    creationPolicy: Owner
  data:
    - secretKey: postgres-password
      remoteRef:
        key: {{ .Values.awsSecretsManager.postgresqlSecretId | quote }}
        property: postgres-password
    - secretKey: username
      remoteRef:
        key: {{ .Values.awsSecretsManager.postgresqlSecretId | quote }}
        property: username
    - secretKey: password
      remoteRef:
        key: {{ .Values.awsSecretsManager.postgresqlSecretId | quote }}
        property: password
    - secretKey: stratium-user
      remoteRef:
        key: {{ .Values.awsSecretsManager.postgresqlSecretId | quote }}
        property: stratium-user
    - secretKey: stratium-password
      remoteRef:
        key: {{ .Values.awsSecretsManager.postgresqlSecretId | quote }}
        property: stratium-password

{{- $adminKeySecretName := default "stratium-admin-key" .Values.keyManager.adminKey.secretName }}
{{- if and $adminKeySecretName .Values.awsSecretsManager.adminKeySecretId }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $adminKeySecretName }}
  labels:
    {{- include "stratium.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ $refresh }}
  secretStoreRef:
    name: {{ $storeName }}
    kind: {{ $storeKind }}
  target:
    name: {{ $adminKeySecretName }}
    creationPolicy: Owner
  data:
    - secretKey: admin-key
      remoteRef:
        key: {{ .Values.awsSecretsManager.adminKeySecretId | quote }}
{{- end }}
{{- end }}

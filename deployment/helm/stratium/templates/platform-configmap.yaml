{{- if .Values.platform.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "stratium.fullname" . }}-platform-config
  labels:
    {{- include "stratium.platform.labels" . | nindent 4 }}
data:
  stratium.yaml: |
    # Platform Service Configuration
    service:
      name: platform-server
      version: 1.0.0
      environment: development
      policy_cache_ttl_seconds: {{ default 5 .Values.platform.config.policyCacheTTLSeconds }}

    server:
      host: "0.0.0.0"
      port: {{ .Values.platform.config.port }}
      read_timeout: 30s
      write_timeout: 30s
      idle_timeout: 300s

    database:
      driver: postgres
      {{- if .Values.postgresql.enabled }}
      host: {{ include "stratium.postgresql.host" . }}
      port: {{ .Values.postgresql.service.port }}
      database: stratium_pap
      user: {{ .Values.postgresql.auth.stratiumUser }}
      password: {{ .Values.postgresql.auth.stratiumPassword }}
      {{- else }}
      host: {{ .Values.externalDatabase.host }}
      port: {{ .Values.externalDatabase.port }}
      database: stratium_pap
      user: {{ .Values.externalDatabase.username }}
      password: {{ .Values.externalDatabase.password }}
      {{- end }}
      {{- if .Values.postgresql.enabled }}
      sslmode: disable
      {{- else }}
      sslmode: require
      {{- end }}
      max_open_conns: 50
      max_idle_conns: 10

    cache:
      type: redis
      ttl: 10m
      redis:
        address: {{ include "stratium.redis.serviceName" . }}:{{ .Values.redis.service.port }}
        db: 0
        prefix: "stratium:policy:"

    logging:
      level: info
      format: json
      output: stdout

    {{- $rate := default (dict) .Values.keyAccess.config.rateLimiting }}
    security:
      rate_limiting:
        enabled: {{ default false $rate.enabled }}
        requests_per_min: {{ default 1000 $rate.requestsPerMin }}
        burst: {{ default 500 $rate.burst }}
{{- end }}

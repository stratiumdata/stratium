{
  "id": null,
  "title": "Stratium Telemetry",
  "uid": "stratium-observability",
  "schemaVersion": 38,
  "version": 1,
  "style": "dark",
  "editable": true,
  "panels": [
    {
      "type": "timeseries",
      "title": "PDP p95 latency (ms)",
      "id": 1,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 0
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(stratium_platform_pdp_decision_duration_ms_milliseconds_bucket[$__interval])) by (le))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Key Access wrap latency p95 (ms)",
      "id": 2,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 0
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(stratium_key_access_wrap_duration_ms_milliseconds_bucket[$__interval])) by (le))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "PDP requests per second",
      "id": 3,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 8
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_platform_pdp_requests_total[$__interval]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Policy cache hit ratio",
      "id": 4,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 8
      },
      "targets": [
        {
          "expr": "1 - (sum(rate(stratium_platform_pdp_policy_cache_events_total{result=\"miss\"}[$__interval])) / sum(rate(stratium_platform_pdp_policy_cache_events_total[$__interval])))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Service key cache hit ratio",
      "id": 5,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 16
      },
      "targets": [
        {
          "expr": "1 - (sum(rate(stratium_key_access_service_key_cache_events_total{result=\"miss\"}[$__interval])) / sum(rate(stratium_key_access_service_key_cache_events_total[$__interval])))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Key Access requests per second",
      "id": 6,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 16
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_key_access_wrap_requests_total[$__interval]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Policies evaluated per decision (p95)",
      "id": 7,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 24
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,outcome) (rate(stratium_platform_pdp_policy_eval_steps_bucket[$__interval])))",
          "legendFormat": "{{outcome}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Entitlements scanned per decision (p95)",
      "id": 8,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 24
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,outcome) (rate(stratium_platform_pdp_entitlement_eval_steps_bucket[$__interval])))",
          "legendFormat": "{{outcome}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Default deny rate",
      "id": 9,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 32
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_platform_pdp_default_deny_total[$__interval]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Key Manager cache hit ratio",
      "id": 10,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 32
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_key_manager_cache_events_total{result=\"hit\"}[$__interval])) by (cache) / sum(rate(stratium_key_manager_cache_events_total[$__interval])) by (cache)",
          "legendFormat": "{{cache}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Key Manager DB p95 latency",
      "id": 11,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 40
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,table) (rate(stratium_key_manager_db_query_duration_ms_bucket[$__interval])))",
          "legendFormat": "{{table}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Key Manager DB errors per second",
      "id": 12,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 40
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_key_manager_db_query_errors_total[$__interval])) by (table)",
          "legendFormat": "{{table}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Scheduled rotation jobs",
      "id": 13,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 48
      },
      "targets": [
        {
          "expr": "sum(stratium_key_manager_rotation_jobs)",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Rotation duration p95 (ms)",
      "id": 14,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 48
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,result) (rate(stratium_key_manager_rotation_duration_ms_bucket[$__interval])))",
          "legendFormat": "{{result}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Auth token validation p95 latency",
      "id": 15,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 56
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(stratium_auth_token_validation_duration_ms_bucket[$__interval])) by (le))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Auth token validation failures per second",
      "id": 16,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 56
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_auth_token_validation_total{result=\"error\"}[$__interval]))",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "JWKS cache events",
      "id": 17,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 0,
        "y": 64
      },
      "targets": [
        {
          "expr": "sum(rate(stratium_auth_jwks_cache_events_total[$__interval])) by (result)",
          "legendFormat": "{{result}}",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Keycloak request p95 latency (ms)",
      "id": 18,
      "datasource": {
        "type": "prometheus",
        "uid": "prometheus"
      },
      "gridPos": {
        "h": 8,
        "w": 12,
        "x": 12,
        "y": 64
      },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le,path) (rate(stratium_auth_keycloak_http_duration_ms_bucket[$__interval])))",
          "legendFormat": "{{path}}",
          "refId": "A"
        }
      ]
    }
  ]
}
